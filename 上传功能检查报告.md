# 参考主体和分镜图上传功能检查报告

## 检查日期
2025年12月23日

## 检查结果总结
✅ **上传功能正常** - 所有核心功能都正确实现

---

## 详细检查

### 1. 参考主体上传功能

**位置**: `App.tsx` - `handleFileImport` 函数

**检查项**:
- ✅ 文件选择: 支持单个或多个文件选择
- ✅ 文件限制: 参考主体最多上传 1 张
- ✅ 文件大小验证: 最大 5MB 限制
- ✅ 文件类型: 仅接受图片格式 (`accept="image/*"`)
- ✅ 清除旧数据: 上传新参考主体时自动清除旧的
- ✅ 数据转换: 使用 FileReader 转换为 Data URL
- ✅ 位置计算: 自动计算合适的画布位置
- ✅ 尺寸设置: 参考主体宽度 214px，高度 380px
- ✅ 标记: 设置 `isMain: true` 标记为参考主体

**代码片段**:
```typescript
// 参考主体只能上传1张
const maxFiles = type === 'ref' ? 1 : 6;

// 如果是参考主体，先清除现有的参考主体
if (type === 'ref') {
  setItems(prev => prev.filter(it => !it.isMain));
}

// 创建参考主体项
const newItem: StoryboardItem = {
  // ...
  width: type === 'ref' ? 214 : 380,
  height: type === 'ref' ? 380 : 214,
  isMain: type === 'ref',
  // ...
};
```

---

### 2. 分镜图上传功能

**位置**: `App.tsx` - `handleFileImport` 函数

**检查项**:
- ✅ 文件选择: 支持多个文件选择
- ✅ 文件限制: 分镜图最多上传 6 张
- ✅ 文件大小验证: 最大 5MB 限制
- ✅ 文件类型: 仅接受图片格式
- ✅ 并发处理: 最多同时处理 3 个文件
- ✅ 数据转换: 使用 FileReader 转换为 Data URL
- ✅ 位置计算: 自动计算合适的画布位置（4列网格）
- ✅ 尺寸设置: 分镜图宽度 380px，高度 214px
- ✅ 标记: 设置 `isMain: false` 标记为分镜图

**代码片段**:
```typescript
// 分镜最多6张
const maxFiles = type === 'ref' ? 1 : 6;

// 并发控制：一次最多处理3个文件
const MAX_CONCURRENT = 3;

// 创建分镜项
const newItem: StoryboardItem = {
  // ...
  width: type === 'ref' ? 214 : 380,
  height: type === 'ref' ? 380 : 214,
  isMain: type === 'ref',
  // ...
};
```

---

### 3. 上传 UI 界面

**位置**: `components/SidebarLeft.tsx`

**检查项**:
- ✅ 上传按钮: 📥 图标，位置在左侧边栏
- ✅ 菜单显示: 点击按钮显示上传类型选择菜单
- ✅ 参考主体选项: 红色标记，显示"参考主体"
- ✅ 分镜图选项: 紫色标记，显示"导入分镜图片"
- ✅ 提示信息: 
  - 参考主体: "上传参考主体 (最多1张)"
  - 分镜图: "上传分镜图片 (最多6张)"
- ✅ 菜单关闭: 点击选项后自动关闭菜单
- ✅ 外部点击关闭: 点击菜单外部自动关闭

**代码片段**:
```typescript
<button 
  onClick={() => { onImport('ref'); setShowImportMenu(false); }} 
  title={lang === 'zh' ? '上传参考主体 (最多1张)' : 'Upload reference subject (max 1)'}
  className={`px-4 py-3 text-left text-[11px] font-black uppercase tracking-widest rounded-xl hover:bg-red-500 hover:text-white transition-all text-red-500 border border-red-500/20`}
>
  {t.importImage}
</button>
```

---

### 4. 文件处理流程

**流程图**:
```
用户点击上传按钮
    ↓
选择上传类型 (参考主体 或 分镜图)
    ↓
打开文件选择对话框
    ↓
选择文件 (1张 或 最多6张)
    ↓
验证文件大小 (≤ 5MB)
    ↓
使用 FileReader 转换为 Data URL
    ↓
创建 StoryboardItem 对象
    ↓
添加到画布
    ↓
显示在合适的位置
```

---

### 5. 错误处理

**检查项**:
- ✅ 文件大小超限: 显示警告 "文件 '{name}' 超过 5MB 限制，已跳过"
- ✅ 文件读取失败: 捕获错误，继续处理下一个文件
- ✅ 无效文件: 自动过滤，不添加到画布

**代码片段**:
```typescript
// 验证文件大小
const validFiles = filesToProcess.filter((file: File) => {
  if (file.size > MAX_FILE_SIZE) {
    alert(`文件 "${file.name}" 超过 5MB 限制，已跳过`);
    return false;
  }
  return true;
});

reader.onerror = () => {
  console.error(`文件读取失败`);
  processedCount++;
  processNextFile();
};
```

---

### 6. 性能优化

**检查项**:
- ✅ 并发处理: 最多同时处理 3 个文件，避免浏览器卡顿
- ✅ 异步处理: 使用 FileReader 异步读取文件
- ✅ 内存管理: 及时释放 FileReader 对象
- ✅ 进度反馈: 处理完成后一次性更新 UI

**代码片段**:
```typescript
// 并发控制：一次最多处理3个文件
const MAX_CONCURRENT = 3;

// 启动并发处理（最多3个）
for (let i = 0; i < Math.min(MAX_CONCURRENT, validFiles.length); i++) {
  processNextFile();
}
```

---

### 7. 用户体验

**检查项**:
- ✅ 清晰的菜单: 用户可以清楚地选择上传类型
- ✅ 视觉反馈: 按钮有悬停效果
- ✅ 错误提示: 文件过大时显示警告
- ✅ 自动定位: 上传的图片自动放在合适的位置
- ✅ 多语言支持: 中文和英文提示

---

## 功能完整性检查

| 功能 | 状态 | 备注 |
|------|------|------|
| 参考主体上传 | ✅ 正常 | 最多 1 张，自动替换 |
| 分镜图上传 | ✅ 正常 | 最多 6 张，并发处理 |
| 文件大小验证 | ✅ 正常 | 5MB 限制 |
| 文件类型验证 | ✅ 正常 | 仅接受图片 |
| 错误处理 | ✅ 正常 | 显示警告信息 |
| 性能优化 | ✅ 正常 | 并发处理 3 个文件 |
| UI 界面 | ✅ 正常 | 清晰易用 |
| 多语言支持 | ✅ 正常 | 中英文 |

---

## 已知限制

1. **文件大小限制**: 单个文件最大 5MB
   - 原因: 浏览器内存限制
   - 建议: 对于大文件，用户可以先压缩

2. **并发处理限制**: 最多同时处理 3 个文件
   - 原因: 避免浏览器卡顿
   - 建议: 对于大量文件，用户可以分批上传

3. **分镜图限制**: 最多 6 张
   - 原因: UI 布局考虑
   - 建议: 用户可以分批上传

---

## 建议改进

### 可选改进 1: 上传进度显示
```typescript
// 添加上传进度条
const [uploadProgress, setUploadProgress] = useState(0);

// 在处理文件时更新进度
setUploadProgress((processedCount / validFiles.length) * 100);
```

### 可选改进 2: 拖拽上传
```typescript
// 支持拖拽文件到画布
const handleDrop = (e: React.DragEvent) => {
  e.preventDefault();
  const files = e.dataTransfer.files;
  // 处理拖拽的文件
};
```

### 可选改进 3: 图片预览
```typescript
// 上传前显示图片预览
const [preview, setPreview] = useState<string | null>(null);
```

---

## 测试清单

### 参考主体上传测试
- [ ] 上传单个参考主体图片
- [ ] 上传第二个参考主体时，第一个被替换
- [ ] 上传超过 5MB 的文件时显示警告
- [ ] 上传非图片文件时被过滤
- [ ] 参考主体显示在正确的位置
- [ ] 参考主体标记为 "REF"

### 分镜图上传测试
- [ ] 上传单个分镜图
- [ ] 上传多个分镜图（最多 6 张）
- [ ] 上传超过 6 张时，只取前 6 张
- [ ] 上传超过 5MB 的文件时显示警告
- [ ] 分镜图显示在正确的位置
- [ ] 分镜图编号正确

### 并发处理测试
- [ ] 同时上传 6 张分镜图，不卡顿
- [ ] 上传过程中可以继续操作 UI
- [ ] 所有文件都被正确处理

### 错误处理测试
- [ ] 文件读取失败时继续处理其他文件
- [ ] 显示清晰的错误提示
- [ ] 不影响已上传的文件

---

## 总体评价

✅ **上传功能完整且正常**

上传功能实现完整，包括：
- 参考主体和分镜图的区分处理
- 文件大小和类型验证
- 并发处理优化
- 完善的错误处理
- 清晰的用户界面
- 多语言支持

**建议**: 当前功能已经足够满足用户需求，可以考虑在后续版本中添加可选改进（如进度显示、拖拽上传等）。

---

## 相关文件

- `App.tsx` - 上传处理逻辑
- `components/SidebarLeft.tsx` - 上传 UI 界面
- `types.ts` - 数据类型定义

