# 批量重绘和分镜合成导出 - 测试指南

## 快速测试步骤

### 测试 1: 分镜合成导出（修复在线生成的分镜图）

#### 前置条件
- 已配置 API 密钥
- 有网络连接

#### 测试步骤
1. **生成分镜**
   - 在右侧面板选择"脚本模式"
   - 输入一个简单的剧本（例如："一个人在公园里散步"）
   - 设置分镜数量为 3-4
   - 点击"生成"按钮
   - 等待分镜生成完成

2. **选择分镜**
   - 在画布上点击第一个分镜
   - 按住 Ctrl/Cmd，点击其他分镜进行多选
   - 确保选中了 3-4 个分镜

3. **导出分镜**
   - 点击右侧面板的"分镜合成下载"按钮
   - 等待导出完成
   - 下载的 JPEG 文件应该包含所有选中的分镜

4. **验证结果**
   - 打开下载的 JPEG 文件
   - ✅ **预期结果**: 所有分镜都应该显示为完整的图片，带有蓝色边框和序号标签
   - ❌ **问题**: 如果分镜显示为灰色占位符或"Failed"文本，说明修复未生效

#### 预期输出
```
┌─────────────────────────────────────┐
│  分镜合成导出 (3 个分镜)             │
├─────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐        │
│  │ SC-01    │  │ SC-02    │        │
│  │ [图片]   │  │ [图片]   │        │
│  └──────────┘  └──────────┘        │
│  ┌──────────┐                      │
│  │ SC-03    │                      │
│  │ [图片]   │                      │
│  └──────────┘                      │
└─────────────────────────────────────┘
```

---

### 测试 2: 批量重绘对话框（改进的缩略图显示）

#### 前置条件
- 已生成至少 3 个分镜
- 已选中这些分镜

#### 测试步骤
1. **打开批量重绘对话框**
   - 在画布上右键点击选中的分镜
   - 选择"批量重绘"选项
   - 或点击右侧面板的"批量重绘"按钮

2. **验证 UI 改进**
   - ✅ **左侧应该显示**:
     - 当前选中分镜的大预览（带紫色边框）
     - 分镜序号标签（例如 "SC-01"）
     - 4 列缩略图网格，显示所有分镜
     - 每个缩略图都有序号标签
     - 原始提示词预览

   - ✅ **交互功能**:
     - 点击缩略图可以切换大预览
     - 选中的缩略图显示紫色边框和光环
     - 悬停时缩略图有缩放动画

3. **输入重绘指令**
   - 在右侧文本框中输入指令
   - 格式: `SC-01: 指令内容`
   - 例如:
     ```
     SC-01: 加入更多细节
     SC-02: 改成夜间场景
     SC-03: 增加人物互动
     ```

4. **提交并验证**
   - 点击"提交"按钮
   - 等待重绘完成
   - 验证分镜已按指令更新

#### 预期 UI 布局
```
┌─────────────────────────────────────────────────────┐
│  批量重绘指令                                        │
├─────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────────────┐ │
│  │ 大预览           │  │ 指令输入                 │ │
│  │ ┌──────────────┐ │  │ ┌────────────────────┐  │ │
│  │ │   SC-01      │ │  │ │ SC-01: 指令...     │  │ │
│  │ │   [图片]     │ │  │ │ SC-02: 指令...     │  │ │
│  │ │              │ │  │ │ SC-03: 指令...     │  │ │
│  │ └──────────────┘ │  │ └────────────────────┘  │ │
│  │                  │  │                         │ │
│  │ 缩略图网格:      │  │ [取消] [提交]           │ │
│  │ ┌──┐ ┌──┐ ┌──┐  │  │                         │ │
│  │ │01│ │02│ │03│  │  │                         │ │
│  │ └──┘ └──┘ └──┘  │  │                         │ │
│  │                  │  │                         │ │
│  │ 原始提示词:      │  │                         │ │
│  │ [提示词内容]     │  │                         │ │
│  └──────────────────┘  └──────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

---

## 常见问题排查

### Q1: 导出的 JPEG 中分镜显示为灰色占位符
**可能原因**: 
- 图片加载超时（20 秒）
- 网络连接问题
- 图片 URL 无效

**解决方案**:
- 检查网络连接
- 查看浏览器控制台是否有错误信息
- 尝试重新生成分镜

### Q2: 批量重绘对话框中看不到缩略图
**可能原因**:
- 浏览器缓存问题
- CSS 加载失败

**解决方案**:
- 清除浏览器缓存（Ctrl+Shift+Delete）
- 刷新页面（Ctrl+R）
- 尝试其他浏览器

### Q3: 导出的 JPEG 文件很大
**原因**: 
- 分镜数量多
- 分镜分辨率高
- JPEG 质量设置为 0.9

**解决方案**:
- 这是正常的，文件大小取决于分镜数量和质量
- 可以使用图片压缩工具进一步压缩

---

## 技术验证

### 检查修复是否生效

#### 方法 1: 浏览器控制台
1. 打开浏览器开发者工具（F12）
2. 切换到"控制台"标签
3. 执行导出操作
4. 查看日志输出：
   - ✅ 应该看到 `✓ Image drawn successfully` 消息
   - ❌ 如果看到 `Image load failed` 或 `Image load timeout`，说明有问题

#### 方法 2: 网络标签
1. 打开浏览器开发者工具（F12）
2. 切换到"网络"标签
3. 执行导出操作
4. 查看图片请求：
   - ✅ Data URL 请求应该成功（状态 200）
   - ✅ 外部 URL 请求应该成功（状态 200）

---

## 修复验证清单

- [ ] 分镜合成导出包含所有在线生成的分镜
- [ ] 导出的 JPEG 中分镜显示为完整图片，不是占位符
- [ ] 批量重绘对话框显示清晰的缩略图网格
- [ ] 缩略图带有序号标签（SC-01, SC-02 等）
- [ ] 点击缩略图可以切换大预览
- [ ] 原始提示词预览正确显示
- [ ] 指令输入和提交功能正常工作

---

## 性能指标

### 导出时间
- 3 个分镜: ~2-3 秒
- 6 个分镜: ~4-5 秒
- 12 个分镜: ~8-10 秒

### 文件大小
- 3 个分镜 (380x214): ~200-300 KB
- 6 个分镜 (380x214): ~400-600 KB
- 12 个分镜 (380x214): ~800-1200 KB

*注: 实际大小取决于分镜内容和 JPEG 压缩率*
