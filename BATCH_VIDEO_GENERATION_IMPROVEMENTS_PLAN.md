# 批量视频生成改进计划

**创建时间**: 2025-12-31
**状态**: 规范已创建，待实现

---

## 问题分析

### 问题 1: 生成失败的视频无法定位

**当前状态**:
- 批量生成多个视频时，如果某个视频失败，用户无法知道是哪一个失败了
- 没有清晰的失败标记和错误信息
- 无法重新提交失败的视频

**解决方案**:
- 为每个视频分配唯一的场景ID（SC-01, SC-02 等）
- 在UI中清晰显示失败的场景ID和错误信息
- 提供"重新生成"按钮，允许用户重新提交失败的视频
- 实现重试逻辑，自动重试失败的视频

### 问题 2: 视频和提示词没有对应标记

**当前状态**:
- 生成的视频和原始提示词之间没有清晰的对应关系
- 用户无法追踪每个视频的来源
- 批量生成多个视频时容易混淆

**解决方案**:
- 在视频卡片上显示场景ID（SC-01）
- 在视频卡片上显示对应的提示词摘要（前100个字符）
- 用户悬停时显示完整的提示词内容
- 使用不同的颜色或图标区分不同的状态

### 问题 3: 生成的视频没有下载按钮

**当前状态**:
- 生成的视频无法下载到本地
- 用户无法保存或分享生成的视频
- 视频URL可能过期，无法长期保存

**解决方案**:
- 在视频卡片上添加"下载"按钮
- 实现视频下载功能，支持进度显示
- 使用有意义的文件名（包含场景ID和时间戳）
- 将视频信息保存到本地存储，支持后续恢复

---

## 改进方案

### 1. 数据模型扩展

**VideoItem 接口**:
```typescript
interface VideoItem {
  id: string;                    // 唯一标识符
  sceneId: string;               // 场景ID（SC-01, SC-02 等）
  visualPrompt: string;          // 画面提示词
  videoPrompt: string;           // 视频提示词
  status: 'pending' | 'generating' | 'success' | 'failed';
  progress: number;              // 进度百分比
  errorMessage?: string;         // 错误信息
  videoUrl?: string;             // 视频URL
  retryCount: number;            // 重试次数
  maxRetries: number;            // 最大重试次数
  createdAt: number;             // 创建时间
  updatedAt: number;             // 更新时间
}
```

### 2. 核心功能

#### 2.1 失败定位和重新生成

- 为每个视频分配唯一的场景ID
- 追踪每个视频的生成状态
- 显示失败原因和错误信息
- 提供重新生成按钮
- 自动重试失败的视频（最多3次）

#### 2.2 视频提示词对应

- 在视频卡片上显示场景ID
- 显示提示词摘要（前100个字符）
- 悬停显示完整提示词
- 使用状态图标区分不同状态（✓/⏳/✗/⏸）

#### 2.3 视频下载功能

- 添加下载按钮（成功时）
- 实现视频下载功能
- 显示下载进度
- 使用有意义的文件名

#### 2.4 批量生成进度

- 显示进度条（已完成/总数）
- 显示统计信息（成功/失败/总数）
- 提供筛选选项（显示全部/仅显示失败/仅显示成功）

#### 2.5 数据持久化

- 将视频信息保存到本地存储
- 支持页面刷新后恢复
- 支持清除本地存储

---

## 实现步骤

### 第一阶段: 数据模型和管理器（1-3 任务）

1. 扩展 `VideoItem` 接口
2. 创建 `VideoStatusManager` 类
3. 创建 `VideoDownloadManager` 类

### 第二阶段: 核心逻辑（4-9 任务）

4. 改进批量生成逻辑
5. 创建视频卡片组件
6. 创建批量生成进度组件
7. 实现视频下载功能
8. 实现视频重新生成功能
9. 实现本地存储持久化

### 第三阶段: 集成和测试（10-14 任务）

10. 集成改进的批量生成UI
11. 添加错误处理和通知
12. 编写单元测试
13. 编写集成测试
14. 部署到 Vercel

---

## 预期效果

### 用户体验改进

1. **失败定位**
   - 用户可以清晰看到哪个视频失败了
   - 可以快速重新生成失败的视频
   - 自动重试机制减少手动操作

2. **视频追踪**
   - 每个视频都有唯一的场景ID
   - 可以快速找到对应的提示词
   - 批量生成时不会混淆

3. **视频下载**
   - 可以下载生成的视频到本地
   - 支持进度显示
   - 文件名有意义，易于管理

4. **进度显示**
   - 实时显示批量生成进度
   - 显示成功/失败统计
   - 可以筛选查看不同状态的视频

---

## 技术栈

- **前端框架**: React + TypeScript
- **状态管理**: React Hooks + localStorage
- **UI 组件**: 现有组件库
- **API**: 现有视频生成API

---

## 规范文件位置

- **需求文档**: `.kiro/specs/batch-video-generation-improvements/requirements.md`
- **设计文档**: `.kiro/specs/batch-video-generation-improvements/design.md`
- **任务清单**: `.kiro/specs/batch-video-generation-improvements/tasks.md`

---

## 下一步

1. 审查规范文档
2. 确认实现方案
3. 开始实现第一阶段任务
4. 逐步完成所有任务
5. 部署到生产环境

