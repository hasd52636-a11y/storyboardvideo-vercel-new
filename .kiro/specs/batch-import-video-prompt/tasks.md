# 实现计划：批量导入视频提示词支持

## 概述

本实现计划将统一批量导入的解析逻辑，确保视频提示词在所有导入方式中都能被正确保留和使用。实现包括提取统一的解析函数、修复现有函数、更新 UI 文本和模板，以及编写测试。

## 任务

- [x] 1. 提取统一的解析函数
  - 在 ManualSceneInputDialog.tsx 中创建 `parseScenes()` 函数
  - 使用改进的正则表达式：`/<<<([\s\S]*?)>>>([\s\S]*?)(?=<<<|$)/g`
  - 正确提取画面提示词和视频提示词
  - 过滤空的画面提示词
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 2. 修复 handleParseBatch() 函数
  - 使用新的 `parseScenes()` 函数替换现有逻辑
  - 确保解析结果包含视频提示词
  - 保持自动切换到单个模式的行为
  - _Requirements: 1.1, 1.3_

- [ ]* 2.1 编写 parseScenes() 的单元测试
  - **Property 1: 粘贴模式解析正确性**
  - **Validates: Requirements 1.1**
  - 测试包含视频提示词的输入
  - 测试不包含视频提示词的输入
  - 测试空白视频提示词

- [x] 3. 修复 handleFileUpload() 函数
  - 使用新的 `parseScenes()` 函数替换现有逻辑
  - 确保文件导入和直接粘贴使用相同逻辑
  - _Requirements: 1.2, 1.3_

- [ ]* 3.1 编写文件导入的单元测试
  - **Property 2: 文件导入视频提示词保留**
  - **Validates: Requirements 1.2**
  - 测试创建包含视频提示词的文件
  - 验证导入后保留视频提示词

- [ ]* 3.2 编写解析一致性测试
  - **Property 3: 解析逻辑一致性（Round-trip）**
  - **Validates: Requirements 1.3**
  - 生成相同的输入文本
  - 验证文件导入和直接粘贴产生相同结果

- [x] 4. 修复批量生成按钮
  - 使用新的 `parseScenes()` 函数
  - 确保将完整的场景数据（包括视频提示词）传递给 onGenerate
  - _Requirements: 3.1, 3.2, 3.3_

- [ ]* 4.1 编写批量生成数据传递测试
  - **Property 7: 批量生成数据传递**
  - **Validates: Requirements 3.1**
  - 验证生成函数接收到完整的场景数据

- [x] 5. 更新 UI 文本和模板
  - 更新批量模式的格式说明文本
  - 更新 `handleDownloadTemplate()` 中的模板内容
  - 更新批量模式的占位符文本
  - _Requirements: 2.1, 2.2, 4.1, 4.2_

- [ ]* 5.1 编写模板内容验证测试
  - **Property 6: 模板格式兼容性**
  - **Validates: Requirements 2.2**
  - 验证模板能被正确解析

- [x] 6. 验证 UI 显示完整性
  - 确保导入后切换到单个模式时显示视频提示词
  - 验证场景卡片中的视频提示词输入框显示导入的内容
  - _Requirements: 1.4, 4.3_

- [ ]* 6.1 编写 UI 显示完整性测试
  - **Property 4: UI 显示完整性**
  - **Validates: Requirements 1.4**
  - 导入包含视频提示词的场景
  - 验证 UI 显示了视频提示词

- [ ]* 6.2 编写可选字段处理测试
  - **Property 5: 可选字段处理**
  - **Validates: Requirements 2.3**
  - 测试空视频提示词不报错
  - 验证被视为 undefined

- [x] 7. 检查点 - 确保所有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 验证没有编译错误
  - 验证功能正常工作

- [ ]* 7.1 编写集成测试
  - **Property 8: 有视频提示词的生成**
  - **Validates: Requirements 3.2**
  - 测试包含视频提示词的场景生成

- [ ]* 7.2 编写无视频提示词生成测试
  - **Property 9: 无视频提示词的生成**
  - **Validates: Requirements 3.3**
  - 测试不包含视频提示词的场景生成

- [x] 8. 最终检查点 - 确保所有测试通过
  - 运行完整的测试套件
  - 验证所有属性测试通过
  - 验证没有遗留的 console 错误
  - 准备部署

## 注意

- 任务标记为 `*` 的是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了特定的需求以确保可追溯性
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边界情况
- 检查点确保增量验证
