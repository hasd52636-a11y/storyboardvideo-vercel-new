# 视频生成功能实现计划

## 概述

本实现计划将视频生成功能分解为具体的编码任务，按照依赖关系和优先级排序。每个任务都包含具体的代码修改和测试要求。

## 任务列表

- [ ] 1. 项目基础设置与类型定义
  - [ ] 1.1 扩展 types.ts，添加视频相关类型定义
    - 添加 VideoObject、VideoGenerationParams、VideoItem 等类型
    - 添加视频状态枚举和错误类型
    - _需求: 8.1, 12.1_

  - [ ] 1.2 创建 videoService.ts 文件框架
    - 定义 VideoService 类和所有方法签名
    - 配置 API 端点和认证信息
    - _需求: 6.1, 8.1_

  - [ ] 1.3 更新 App.tsx 中的状态管理
    - 添加 videoItems 状态
    - 添加 pollingTasksRef 引用
    - 添加视频相关的 UI 状态（对话框显示/隐藏）
    - _需求: 1.1, 3.1_

- [ ] 2. 实现 VideoService 核心服务
  - [ ] 2.1 实现 createVideo 方法
    - 构建 multipart/form-data 请求
    - 调用 POST /v1/videos 端点
    - 处理响应并返回 VideoObject
    - _需求: 8.1, 8.2_

  - [ ] 2.2 实现 getVideoStatus 方法
    - 调用 GET /v1/videos/{task_id} 端点
    - 解析响应中的 status、progress、video_url 等字段
    - 处理错误响应（status: failed）
    - _需求: 12.1, 13.1_

  - [ ] 2.3 实现 remixVideo 方法
    - 构建 JSON 格式请求体
    - 调用 POST /v1/videos/{task_id}/remix 端点
    - 返回新的 VideoObject 和 task_id
    - _需求: 11.1, 12.1_

  - [ ] 2.4 实现轮询机制（startPolling 和 stopPolling）
    - 启动定期轮询（间隔 2-5 秒）
    - 处理 queued、in_progress、completed、failed 状态
    - 实现最大重试次数限制（120 次）
    - 提供进度回调和完成回调
    - _需求: 12.1, 13.1_

  - [ ]* 2.5 编写 VideoService 的单元测试
    - 测试各个方法的正常流程
    - 测试错误处理和异常情况
    - 测试轮询机制的超时处理
    - _需求: 8.1, 12.1_

- [ ] 3. 实现视频生成对话框组件
  - [ ] 3.1 创建 VideoGenDialog.tsx 组件
    - 显示已选分镜的缩略图列表
    - 显示参考主体预览（如果有）
    - 实现提示词多行输入框
    - _需求: 2.1, 2.2_

  - [ ] 3.2 实现视频方向选择器
    - 支持横屏/竖屏两种选项
    - 根据选择更新可用的分辨率选项
    - _需求: 2.3, 9.1_

  - [ ] 3.3 实现视频分辨率选择器
    - 根据方向动态显示可用分辨率
    - 根据模型类型限制分辨率选项（sora-2 仅 720P，sora-2-pro 支持 1080P）
    - _需求: 2.4, 9.2, 9.3_

  - [ ] 3.4 实现视频时长配置
    - 支持自定义时长（4 秒及以上）或固定选项（10/15/25 秒）
    - 根据 API 分组类型显示不同选项
    - 验证用户输入
    - _需求: 2.5, 10.1, 10.2_

  - [ ] 3.5 实现模型选择和其他参数
    - 模型选择（sora-2 / sora-2-pro）
    - 水印选项
    - 预览提示词功能
    - _需求: 2.1, 5.3_

  - [ ] 3.6 实现对话框的生成和取消逻辑
    - 点击"生成"时调用 VideoService.createVideo()
    - 点击"取消"时关闭对话框并清空数据
    - 显示加载状态
    - _需求: 2.6, 2.7_

  - [ ]* 3.7 编写 VideoGenDialog 的单元测试
    - 测试各个选择器的交互
    - 测试参数验证
    - 测试生成和取消逻辑
    - _需求: 2.1_

- [ ] 4. 实现视频窗口组件
  - [ ] 4.1 创建 VideoWindow.tsx 组件
    - 显示视频播放器（当 status 为 completed）
    - 显示加载动画和进度百分比（当 status 为 loading）
    - 显示错误信息和重试按钮（当 status 为 error）
    - _需求: 3.1, 3.2, 3.3_

  - [ ] 4.2 实现视频窗口的拖拽功能
    - 支持鼠标拖拽移动窗口位置
    - 更新窗口的 x、y 坐标
    - _需求: 4.1_

  - [ ] 4.3 实现视频窗口的操作按钮
    - 编辑按钮：打开编辑对话框
    - 删除按钮：从画布移除视频窗口
    - 下载按钮：下载视频文件
    - _需求: 4.2, 4.3_

  - [ ] 4.4 实现视频窗口的状态管理
    - 根据 VideoObject 的 status 和 progress 更新显示
    - 处理错误状态和重试逻辑
    - _需求: 3.1, 3.2, 3.3_

  - [ ]* 4.5 编写 VideoWindow 的单元测试
    - 测试各个状态的显示
    - 测试拖拽功能
    - 测试操作按钮的回调
    - _需求: 4.1_

- [ ] 5. 实现视频编辑对话框组件
  - [ ] 5.1 创建 VideoEditDialog.tsx 组件
    - 显示原视频预览
    - 显示编辑提示词输入框
    - 实现应用编辑和取消按钮
    - _需求: 11.1, 11.2, 11.3_

  - [ ] 5.2 实现编辑对话框的逻辑
    - 点击"应用编辑"时调用 VideoService.remixVideo()
    - 点击"取消"时关闭对话框
    - 显示加载状态
    - _需求: 11.4, 11.5_

  - [ ]* 5.3 编写 VideoEditDialog 的单元测试
    - 测试编辑提示词的输入
    - 测试应用编辑和取消逻辑
    - _需求: 11.1_

- [ ] 6. 集成视频功能到主应用
  - [ ] 6.1 在 App.tsx 中添加"生成视频"按钮
    - 在导出按钮旁显示按钮
    - 根据选择状态启用/禁用按钮
    - 点击时打开 VideoGenDialog
    - _需求: 1.1, 1.2, 1.3_

  - [ ] 6.2 实现视频窗口的添加和管理
    - 在 App.tsx 中实现 handleAddVideoWindow 函数
    - 在 App.tsx 中实现 handleUpdateVideoWindow 函数
    - 在 App.tsx 中实现 handleDeleteVideoWindow 函数
    - _需求: 3.1, 4.1, 4.2_

  - [ ] 6.3 实现视频生成的完整流程
    - 用户点击"生成视频"→ 打开对话框
    - 用户配置参数 → 点击"生成"
    - 调用 VideoService.createVideo()
    - 创建 VideoWindow 并启动轮询
    - _需求: 1.1, 2.1, 3.1_

  - [ ] 6.4 实现视频编辑的完整流程
    - 用户点击 VideoWindow 的"编辑"按钮
    - 打开 VideoEditDialog
    - 用户输入编辑提示词 → 点击"应用编辑"
    - 调用 VideoService.remixVideo()
    - 更新 VideoWindow 并启动新的轮询
    - _需求: 11.1, 11.2, 11.3_

  - [ ] 6.5 实现视频下载功能
    - 点击"下载"按钮时下载视频文件
    - 使用视频 URL 和合适的文件名
    - _需求: 4.3_

  - [ ]* 6.6 编写集成测试
    - 测试完整的视频生成流程
    - 测试完整的视频编辑流程
    - 测试多个视频窗口的独立管理
    - _需求: 1.1, 3.1, 11.1_

- [ ] 7. 实现错误处理和用户反馈
  - [ ] 7.1 实现 API 错误处理
    - 捕获 API 调用失败
    - 解析错误响应（error.code 和 error.message）
    - 显示用户友好的错误信息
    - _需求: 6.6, 6.7_

  - [ ] 7.2 实现轮询超时处理
    - 检测轮询超时（120 次重试）
    - 显示超时错误信息
    - 提供重试选项
    - _需求: 13.6_

  - [ ] 7.3 实现内容安全提示
    - 显示 API 返回的内容违规错误
    - 提供重新生成选项
    - _需求: 6.7_

  - [ ] 7.4 实现加载状态和进度显示
    - 显示"排队中..."、"生成中..."等状态
    - 显示进度百分比
    - 显示"生成完成"状态
    - _需求: 3.2, 13.3_

  - [ ]* 7.5 编写错误处理的单元测试
    - 测试各种错误场景
    - 测试错误信息的显示
    - _需求: 6.1, 7.1_

- [ ] 8. 性能优化和清理
  - [ ] 8.1 实现轮询优化
    - 用户关闭窗口时停止轮询
    - 及时清理已完成的轮询任务
    - 防止内存泄漏
    - _需求: 13.7_

  - [ ] 8.2 实现内存管理
    - 限制画布上同时显示的视频窗口数量
    - 清理已删除视频的相关数据
    - _需求: 4.5_

  - [ ] 8.3 实现网络优化
    - 压缩参考图片大小
    - 实现请求重试机制
    - _需求: 8.1_

  - [ ]* 8.4 编写性能测试
    - 测试多个视频窗口的性能
    - 测试轮询机制的资源占用
    - _需求: 4.5_

- [ ] 9. 文档和部署
  - [ ] 9.1 编写 VideoService 的 API 文档
    - 记录所有方法的参数和返回值
    - 提供使用示例
    - _需求: 8.1_

  - [ ] 9.2 编写组件使用文档
    - 记录 VideoGenDialog、VideoEditDialog、VideoWindow 的 props
    - 提供集成示例
    - _需求: 7.1_

  - [ ] 9.3 编写配置文档
    - 记录 API 端点和认证信息的配置方式
    - 记录轮询参数的配置方式
    - _需求: 6.1, 6.3_

  - [ ] 9.4 更新项目 README
    - 添加视频生成功能的说明
    - 添加快速开始指南
    - _需求: 1.1_

- [ ] 10. 最终检查与测试
  - [ ] 10.1 运行所有单元测试
    - 确保所有测试通过
    - 检查代码覆盖率
    - _需求: 2.5, 3.7, 4.5, 5.3, 7.5, 8.4_

  - [ ] 10.2 运行集成测试
    - 测试完整的视频生成流程
    - 测试完整的视频编辑流程
    - 测试错误处理
    - _需求: 6.6_

  - [ ] 10.3 进行端到端测试
    - 手动测试用户完整的操作流程
    - 测试各种错误场景
    - 测试性能和稳定性
    - _需求: 1.1, 3.1, 11.1_

  - [ ] 10.4 代码审查和优化
    - 检查代码质量和风格
    - 优化性能瓶颈
    - 修复任何发现的问题
    - _需求: 8.1, 8.2, 8.3_

  - [ ] 10.5 准备发布
    - 更新版本号
    - 生成 changelog
    - 准备发布说明
    - _需求: 1.1_

## 任务执行指南

### 执行顺序

1. **第一阶段**：基础设置（任务 1）
   - 完成类型定义和项目框架
   - 为后续开发奠定基础

2. **第二阶段**：核心服务（任务 2）
   - 实现 VideoService 的所有方法
   - 这是整个功能的核心

3. **第三阶段**：UI 组件（任务 3、4、5）
   - 实现各个 UI 组件
   - 可以并行开发

4. **第四阶段**：集成和测试（任务 6、7）
   - 将组件集成到主应用
   - 实现错误处理

5. **第五阶段**：优化和部署（任务 8、9、10）
   - 性能优化
   - 文档编写
   - 最终测试

### 标记说明

- 带 `*` 的子任务是可选的测试任务
- 可以先完成核心功能，再补充测试
- 但建议至少完成集成测试（任务 6.6）

### 依赖关系

```
任务 1 (基础设置)
    ↓
任务 2 (核心服务)
    ↓
任务 3、4、5 (UI 组件) ← 可并行
    ↓
任务 6 (集成)
    ↓
任务 7 (错误处理)
    ↓
任务 8 (优化)
    ↓
任务 9 (文档)
    ↓
任务 10 (最终检查)
```

## 预期工作量

- **基础设置**：1-2 小时
- **核心服务**：3-4 小时
- **UI 组件**：4-6 小时
- **集成和测试**：3-4 小时
- **错误处理**：2-3 小时
- **优化和部署**：2-3 小时

**总计**：约 15-22 小时（取决于测试覆盖率和优化程度）

## 成功标准

- ✅ 所有核心功能都已实现
- ✅ 用户可以完整地生成、编辑和下载视频
- ✅ 所有错误场景都有适当的处理和提示
- ✅ 代码质量达到项目标准
- ✅ 文档完整且易于理解
- ✅ 性能满足用户期望

