# 🎯 最终问题诊断 - 单分镜 vs 多分镜

**诊断时间**: 2025年12月25日  
**数据**: 单分镜 API 日志 + 多分镜 API 日志

---

## 📊 数据对比

### 单分镜视频

```json
{
  "task_id": "video_23701025-5b8a-49c2-9720-e0f590973b85",
  "status": "SUCCESS",
  "submit_time": 1766661692,
  "start_time": 1766661703,
  "finish_time": 1766661844,
  "duration": 152秒 (2.5分钟),
  "images": [1张图片],
  "prompt": "[动作]: 【SC-05】\n[运镜]: 无",
  "video_url": "https://midjourney-plus.oss-us-west-1.aliyuncs.com/sora/334a27d7-36ee-4d33-aa73-9ca9e028a66e.mp4"
}
```

### 多分镜视频

```json
{
  "task_id": "sora-2:9c957108-9604-4338-b861-2de45642a67a",
  "status": "SUCCESS",
  "submit_time": 1766656986,
  "start_time": 1766656997,
  "finish_time": 1766659907,
  "duration": 2921秒 (49分钟),
  "images": [5张图片],
  "prompt": "【全局指令】...【SC-01】...【SC-02】...【SC-03】...【SC-04】...【SC-05】...",
  "video_url": "https://filesystem.site/cdn/20251225/496980aaef83f56bd8020581241f79.mp4"
}
```

---

## 🔍 关键差异分析

### 差异 1: 处理时间

| 项目 | 单分镜 | 多分镜 |
|------|--------|--------|
| 处理时间 | **152秒** (2.5分钟) | **2921秒** (49分钟) | 
| 倍数 | 1x | **19.2x** |

**结论**: 多分镜处理时间是单分镜的 **19 倍**！

### 差异 2: 提示词长度

**单分镜**:
```
[动作]: 【SC-05】
[运镜]: 无
```
长度: ~30 字符

**多分镜**:
```
【全局指令】必须按照以下规则生成视频：
1、禁止将参考图写入画面，按照参考图标注的序号生成视频
2、保持写实摄影风格
3、4:3画幅
【限制性指令】禁止闪烁，严禁背景形变，保持角色一致性。
单一连续电影镜头，沉浸式360度环境，无分屏，无边框，无分镜布局，无UI
【约束条件】不修改参考主体特征 | 保持视觉连续性 | 严格按编号顺序

【SC-01】...【SC-02】...【SC-03】...【SC-04】...【SC-05】...
```
长度: ~1000+ 字符

**结论**: 多分镜提示词是单分镜的 **30+ 倍**！

### 差异 3: 视频 URL 来源

**单分镜**:
```
https://midjourney-plus.oss-us-west-1.aliyuncs.com/sora/...
```
来源: Aliyun OSS

**多分镜**:
```
https://filesystem.site/cdn/20251225/...
```
来源: filesystem.site

**结论**: 不同的存储服务！

---

## 🎯 真正的问题

### 问题 1: 前端轮询超时

**现象**:
- 单分镜: 152秒 < 30分钟超时 ✅
- 多分镜: 2921秒 (49分钟) > 30分钟超时 ❌

**原因**: 轮询超时设置为 30 分钟，但多分镜需要 49 分钟

**解决方案**: 已修改为 60 分钟 ✅

### 问题 2: 视频 URL 来源不同

**现象**:
- 单分镜: Aliyun OSS
- 多分镜: filesystem.site

**可能原因**:
- 不同的 API 版本
- 不同的存储配置
- 不同的地域

**影响**: 可能导致 CORS 问题

### 问题 3: 提示词格式差异

**单分镜**:
```
简单格式: [动作]: ... [运镜]: ...
```

**多分镜**:
```
复杂格式: 【全局指令】...【SC-01】...【SC-02】...
```

**问题**: 前端生成的提示词格式可能不同

---

## 🔧 需要修复的问题

### 修复 1: 轮询超时 ✅ (已完成)

```typescript
// 改为 60 分钟
timeoutMs: number = 60 * 60 * 1000
```

### 修复 2: 导出分镜图 CORS 问题

**现象**: 浏览器控制台显示
```
Image load failed for URL: https://maas-watermark-prod.cn-wlcb.ufileos.com/...
```

**原因**: UCloud CDN 没有配置 CORS

**解决方案**: 使用 CORS 代理

### 修复 3: 批量重绘只重绘一张

**原因**: 批量重绘逻辑有问题

**解决方案**: 修复循环逻辑

### 修复 4: 生成视频缺少提示词

**原因**: VideoGenDialog 没有加载对应分镜的提示词

**解决方案**: 复用 `getOptimizedPrompts()` 函数

---

## 📋 修复优先级

| 优先级 | 问题 | 状态 | 时间 |
|--------|------|------|------|
| 🔴 高 | 轮询超时 | ✅ 已修复 | - |
| 🔴 高 | 导出分镜图 CORS | ⏳ 待修复 | 30分钟 |
| 🔴 高 | 批量重绘 | ⏳ 待修复 | 20分钟 |
| 🟡 中 | 生成视频提示词 | ⏳ 待修复 | 20分钟 |

---

## 🚀 下一步行动

### 第 1 步: 部署轮询超时修复

```bash
vercel --prod
```

### 第 2 步: 修复导出分镜图

使用 CORS 代理处理 UCloud CDN 图片

### 第 3 步: 修复批量重绘

支持多图重绘

### 第 4 步: 修复生成视频

加载对应分镜的提示词

---

## 📊 预期效果

修复后:
- ✅ 单分镜视频: 正常 (已验证)
- ✅ 多分镜视频: 正常 (修复后)
- ✅ 导出分镜图: 正常 (修复后)
- ✅ 批量重绘: 正常 (修复后)
- ✅ 生成视频: 正常 (修复后)

---

## 总结

**单分镜成功的原因**:
- 处理时间短 (2.5分钟)
- 提示词简单
- 轮询超时充足

**多分镜失败的原因**:
- 处理时间长 (49分钟)
- 轮询超时不足 (30分钟)
- 导出和批量操作有 CORS 问题

**解决方案**:
- ✅ 增加轮询超时到 60 分钟 (已完成)
- ⏳ 修复 CORS 问题 (待完成)
- ⏳ 修复批量重绘 (待完成)
- ⏳ 修复生成视频提示词 (待完成)

---

**诊断完成**: 2025-12-25  
**建议**: 立即部署轮询超时修复，然后逐一修复其他问题
